#!/usr/bin/env python

import sys
import flo_utils as fu
from argparse import ArgumentParser
import re

parser = ArgumentParser()
parser.description = "A script to plot a variable in a netCDF file over a GeoTiff. Uses GDAL python bindings, Proj4, and Basemap. Script is fine-tuned for whole Greenland plots, but can be adapted for other needs."
parser.add_argument("FILE", nargs='*')
parser.add_argument("-v", "--variables", dest="varname",
                  help='''Variables to plot, default = 'usurf,cbar,...'.''', default="cbar,usurf,thk,cbase,diffusivity,topg")
parser.add_argument("-n", "--noshow", dest="noshow", action="store_true",
                  help='''do not open eog on results''', default=False)
parser.add_argument("-l", "--level",  default= None,
                  help='''level to plot''', type = int)
parser.add_argument("--coords",  default= None,
                  help='''coordinate file''')

parser.add_argument("-s", "--sub",  
                  help='''File to substract''', default=None)

parser.add_argument("--bounds", dest="bounds", nargs=2, type=float,
                  help="lower and upper bound for colorbar, eg. -1 1", default=None)
parser.add_argument("--numcol", dest="numcol", type=int,
                  help="number of color steps", default=None)
parser.add_argument("--overlay", dest="overlay", 
                  help="overlay variable", default=None)
parser.add_argument("--colormap", dest="colormap", 
                  help="colormap", default=None)
parser.add_argument("--title", dest="title", 
                  help="inner plot title", default=None)

options = parser.parse_args()
variables = (options.varname).split(",")
print options.varname
print variables
outfiles  = []
filenames = options.FILE
print filenames
fu.debug=True

miscopts = " -a "   # alaska albers
levelstring = ""
if options.level:
  miscopts = miscopts + " --level %i"%(options.level)
  levelstring = "_l%i"%(options.level)

if options.bounds:
  miscopts = miscopts + " --bounds %f %f "%(options.bounds[0], options.bounds[1])

if options.numcol:
    miscopts = miscopts + " --numcol %i "%(options.numcol)

if options.colormap:
    miscopts = miscopts + " --colormap %s "%(options.colormap)

if options.overlay:
    miscopts = miscopts + " --overlay %s "%(options.overlay)

if options.title:
    miscopts = miscopts+ " --inner_titles '%s' "%(options.title)

if options.coords:
    miscopts = miscopts + " --coords %s "%(options.coords)
    
substring = ""
if options.sub:
  miscopts = miscopts + " --obs_file %s "%(options.sub)
  substring = "-%s"%(re.sub("/","_",options.sub))
  
for variable in variables:
  for filename in filenames:
    print "plotting %s from %s"%(variable, filename)
    outfilename = "%s%s_%s%s.png"%(variable, levelstring, filename, substring)
    ret = fu.qo("/home/flo/Apps/pypismtools/scripts/basemap-plot.py --singlerow -v " + variable + " --colorbar_label %s -o %s %s"%(miscopts, outfilename, filename))
    print (ret)
    outfiles.append( outfilename )

if  options.noshow :
  print "scp high1.gi.alaska.edu:t1/{" +  ",".join(outfiles) + "} ."
else : 
  fu.qo(["/usr/bin/eog"] + outfiles )




