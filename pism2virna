#!/bin/bash

echo WARNING: MIGHT BE BUGGY, JUST FOR DEVELOPMENT / TESTING

set -evx

datadir=/work/ba0989/work_bm0948/
topo_file=modified-RTopo-2.0.1_30sec_surface_bathy_remap_after.nc
rtf="-remapbil,$datadir/$topo_file "
min_ocean=50
nthreads=2
for num in $@  ; do 
    cdo -s -P 2 ${rtf} -selvar,thk,topg,usurf ../pism/pv_${num}.nc ttg_${num}.nc
    ice_nh=" -setmisstoc,0 -ifthen -gtc,10 -selvar,thk ttg_${num}.nc -selvar,usurf ttg_${num}.nc" 


    #    ice_sh=" -setmisstoc,0 -ifthen -gtc,10 -selvar,thk ${datadir}/thk_SH_10minbil.nc  ${usf_sh} " # s.o.
    background="-add -selvar,DEPTO ${datadir}/${topo_file}  ${rtf} -selvar,delta_topg ../vilma_for_pv/pv_${num}.nc"
    background_no_land_lost="-ifthenelse -gtc,0 $datadir/$topo_file -max  $datadir/$topo_file $background $background"
    cdo -s -P 2  $background background.nc
    cdo -s -P 2 $background_no_land_lost background_no_land_lost.nc
    cdo -s -P 2 -setname,topg -ifthenelse  ${ice_nh}  ${ice_nh}  ${background_no_land_lost} usf_${num}.nc  # vilma + bg
    
#    rm ttg_${num}.nc
done
